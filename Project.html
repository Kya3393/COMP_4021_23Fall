<!DOCTYPE html>
<html>
<head>
    <title>Shoot Guns!</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P" rel="stylesheet">
    <link href="style.css" rel="stylesheet"> 
</head>
<body>
    <div id="game-container">
        <canvas width="1000px" height="1000px"></canvas>

        <svg xmlns="http://www.w3.org/2000/svg" id="counter">
            <text x="10" y="35">
                TIME:<tspan id="time-remaining">20</tspan>
            </text>
        </svg>

        <svg xmlns="http://www.w3.org/2000/svg" id="game-start">
            <defs>
                <linearGradient id="title-fill" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0.2" stop-color="red" />
                    <stop offset="0.4" stop-color="yellow" />
                    <stop offset="0.6" stop-color="green" />
                    <stop offset="0.8" stop-color="purple" />
                </linearGradient>
            </defs>
            <text id="game-title" x="50%" y="45%">KYS!</text>
            <text x="50%" y="60%">Click here to start the game</text>
        </svg>

        <svg xmlns="http://www.w3.org/2000/svg" id="game-over" style="display: none">
            <defs>
                <linearGradient id="game-over-fill" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0" stop-color="red" />
                    <stop offset="0.5" stop-color="yellow" />
                    <stop offset="1" stop-color="red" />
                </linearGradient>
            </defs>
            <text x="50%" y="50%">
                Time's up! You have killed
                <tspan id="final-gems">0</tspan>
                enemy(ies).
            </text>
        </svg>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="bounding_box.js"></script>
    <script src="sprite.js"></script>
    <script src="player.js"></script>
    <script src="bullet.js"></script>
    <script>
    $(document).ready(function() {
        /* Get the canvas and 2D context */
        const cv = $("canvas").get(0);
        const ctx = cv.getContext("2d");

        /* Create the sounds
        const sounds = {
            background: new Audio("background.mp3"),
            collect: new Audio("collect.mp3"),
            gameover: new Audio("gameover.mp3")
        };*/

        const totalGameTime = 60*3;   // Total game time in seconds
        let gameStartTime = 0;      // The timestamp when the game starts
        let killCounts = 0;      // The number of gems collected in the game

        /* Create the game area */
        const gameArea = BoundingBox(ctx, 50, 50, 950, 950);

        /* Create the sprites in the game */
        const player = Player(ctx, 500, 500, gameArea); // The player
        const bullets = [];

        // Cursor pos tracking
        let mouse_pos = { x: 0, y: 0 };
        cv.addEventListener('mousemove', handleMouseMove);
        function handleMouseMove(event) {
            // Get the position of the mouse relative to the canvas
            const rect = cv.getBoundingClientRect();
            mouse_pos.x = event.clientX - rect.left;
            mouse_pos.y = event.clientY - rect.top;
            console.log('Mouse position:', mouse_pos.x, mouse_pos.y);
        }
        
		
        /* The main processing of the game */
        function doFrame(now) {
            if (gameStartTime == 0) gameStartTime = now;
			
            /* Update the time remaining */
            const gameTimeSoFar = now - gameStartTime;
            const timeRemaining = Math.ceil((totalGameTime * 1000 - gameTimeSoFar) / 1000);
            $("#time-remaining").text(timeRemaining);

            /* TODO */
            /* Handle the game over situation here */
            /*if(timeRemaining <= 0){
                $("#final-gems").text(collectedGems.toString());
                $("#game-over").show();
                sounds.gameover.play();
                return;
            }*/

            /* Update the sprites */
            player.update(now);
            /* Delete out of bound bullets */
            for( const del_bullet of bullets){
                const bullet_pos = del_bullet.getXY();
                if(!gameArea.isPointInBox(bullet_pos.x, bullet_pos.y)){
                    console.log("delete bullet");
                    bullets.splice(bullets.findIndex(bullet => bullet == del_bullet), 1);
                }
                
            }
            

            /* Remove bullet */
            // for( const del_bullet of bullets){
            //     if(del_bullet.getAge(now) >= 3000){//testing purpose
            //     bullets.splice(bullets.findIndex(bullet => bullet == del_bullet), 1);
            //     }
            // }
            /* TODO */
            /* Randomize the gem and collect the gem here */
			/*
            let gem_pos = gem.getXY();
            if(gem.getAge(now) >= gemMaxAge){
                gem.randomize(gameArea);
            }
            //if( (player.getBoundingBox()).intersect(gem.getBoundingBox())){
            if( (player.getBoundingBox()).isPointInBox(gem_pos.x, gem_pos.y)){    
                collectedGems++;
                sounds.collect.currentTime = 0;
                sounds.collect.play();
                gem.randomize(gameArea);
            }
			*/


            /* Clear the screen */
            ctx.clearRect(0, 0, cv.width, cv.height);

            /* Draw the sprites */
            player.draw();
            for( const bullet of bullets){
                bullet.draw();
            }


            requestAnimationFrame(doFrame);
        }
        

        /* Handle the start of the game */
        $("#game-start").on("click", function() {

            /* Hide the start screen */
            $("#game-start").hide();
                
			/* Handle the keydown of arrow keys and spacebar */
            $(document).on("keydown", function(event) {

                /* Handle the key down */
                // W key
                if (event.keyCode === 87) {
                    player.move(2); // Move up
                }
                // S key
                if (event.keyCode === 83) {
                    player.move(4); // Move down
                }
                // A key
                if (event.keyCode === 65) {
                    player.move(1); // Move left
                }
                // D key
                if (event.keyCode === 68) {
                    player.move(3); // Move right
                }
                // B key
                if (event.keyCode === 66) {
                    //const bullet = Bullet(cv, ); // The player
                    // TEST
                    let{x, y} = player.getXY();
                    const test_bullet = Bullet(ctx, x, y, mouse_pos.x, mouse_pos.y);
                    bullets.push(test_bullet);
                    console.log("shoot");
                }

                // spacebar key ( cheat )
                if(event.keyCode == 32){
                    player.speedUp();
                }

            });

            /* Handle the keyup of arrow keys and spacebar */
            $(document).on("keyup", function(event) {


                /* TODO */
                /* Handle the key up */
                // W key
                if (event.keyCode === 87) {
                    player.stop(2); // Move up
                }
                // S key
                if (event.keyCode === 83) {
                    player.stop(4); // Move down
                }
                // A key
                if (event.keyCode === 65) {
                    player.stop(1); // Move left
                }
                // D key
                if (event.keyCode === 68) {
                    player.stop(3); // Move right
                }

                // spacebar key ( cheat )
                if(event.keyCode == 32){
                    player.slowDown();
                }

            });

            /* Start the game */
            requestAnimationFrame(doFrame);
            
        });
    });
    </script>
</body>
</html>
